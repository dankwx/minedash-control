<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - MHASSAHROPOLIS</title>
    <link rel="preconnect" href="https://fonts.bunny.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.bunny.net/css?family=geist-mono:400,500,600,700" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        /* ============================================
           PROFILE PAGE - TWO COLUMN LAYOUT
           ============================================ */
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            padding: 0;
        }

        .page-layout {
            display: flex;
            flex: 1;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 80px 1rem 2rem;
            gap: 2rem;
        }

        /* ============================================
           MEMBERS SIDEBAR
           ============================================ */
        .members-sidebar {
            width: 280px;
            flex-shrink: 0;
        }

        .members-card {
            background: var(--card);
            border: 1px solid var(--border-light);
            position: sticky;
            top: 80px;
        }

        .members-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-light);
        }

        .members-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--muted-foreground);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-family: 'Geist Mono', monospace;
        }

        .members-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .member-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 1.25rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--border-light);
        }

        .member-item:last-child {
            border-bottom: none;
        }

        .member-item:hover {
            background: rgba(255,255,255,0.02);
        }

        .member-item.active {
            background: rgba(74, 222, 128, 0.05);
            border-left: 2px solid var(--accent);
        }

        .member-item.is-you {
            background: rgba(74, 222, 128, 0.03);
        }

        .member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid var(--border-light);
        }

        .member-info {
            flex: 1;
            min-width: 0;
        }

        .member-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--foreground);
            font-family: 'Geist Mono', monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .member-status {
            font-size: 10px;
            color: var(--muted-foreground);
            font-family: 'Geist Mono', monospace;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .member-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--muted-foreground);
        }

        .member-status-dot.online {
            background: var(--accent);
        }

        .member-you-badge {
            font-size: 9px;
            color: var(--accent);
            background: rgba(74, 222, 128, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Geist Mono', monospace;
        }

        /* ============================================
           MAIN PROFILE CONTENT
           ============================================ */
        .profile-main {
            flex: 1;
            min-width: 0;
        }

        .profile-card {
            width: 100%;
            background: var(--card);
            border: 1px solid var(--border-light);
            padding: 2rem;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-light);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid var(--border-light);
        }

        .profile-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .profile-name {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--foreground);
            font-family: 'Geist Mono', monospace;
        }

        .profile-id {
            font-size: 11px;
            color: var(--muted-foreground);
            font-family: 'Geist Mono', monospace;
            letter-spacing: 0.05em;
        }

        .profile-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: rgba(74, 222, 128, 0.1);
            border: 1px solid rgba(74, 222, 128, 0.3);
            border-radius: 4px;
            font-size: 10px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 0.5rem;
            width: fit-content;
        }

        .profile-badge::before {
            content: '‚óè';
            font-size: 8px;
        }

        .profile-badge.you {
            background: rgba(74, 222, 128, 0.15);
        }

        .profile-section {
            margin-bottom: 1.5rem;
        }

        .profile-section:last-child {
            margin-bottom: 0;
        }

        .profile-section-title {
            font-size: 10px;
            font-weight: 600;
            color: var(--muted-foreground);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            margin-bottom: 1rem;
            font-family: 'Geist Mono', monospace;
        }

        .profile-field {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-light);
        }

        .profile-field:last-child {
            border-bottom: none;
        }

        .profile-field-label {
            font-size: 12px;
            color: var(--muted-foreground);
            font-family: 'Geist Mono', monospace;
        }

        .profile-field-value {
            font-size: 12px;
            color: var(--foreground);
            font-family: 'Geist Mono', monospace;
        }

        .back-link {
            display: inline-block;
            margin-top: 1.5rem;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.1em;
            color: var(--muted-foreground);
            text-decoration: none;
            padding: 8px 16px;
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
            text-transform: uppercase;
        }

        .back-link:hover {
            color: var(--accent);
            border-color: rgba(74, 222, 128, 0.3);
            background: rgba(74, 222, 128, 0.05);
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            padding: 3rem;
            color: var(--muted-foreground);
            font-size: 12px;
            font-family: 'Geist Mono', monospace;
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-light);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .not-logged-in {
            text-align: center;
            padding: 3rem;
        }

        .not-logged-in p {
            color: var(--muted-foreground);
            font-size: 12px;
            margin-bottom: 1.5rem;
            font-family: 'Geist Mono', monospace;
        }

        /* ============================================
           LAST.FM SECTION
           ============================================ */
        .lastfm-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-light);
        }

        .lastfm-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .lastfm-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 10px;
            font-weight: 600;
            color: var(--muted-foreground);
            text-transform: uppercase;
            letter-spacing: 0.15em;
            font-family: 'Geist Mono', monospace;
        }

        .lastfm-icon {
            width: 16px;
            height: 16px;
            fill: #d51007;
        }

        .lastfm-username {
            font-size: 10px;
            color: var(--muted-foreground);
            font-family: 'Geist Mono', monospace;
        }

        .lastfm-username a {
            color: #d51007;
            text-decoration: none;
            transition: opacity 0.2s;
        }

        .lastfm-username a:hover {
            opacity: 0.8;
        }

        .lastfm-unavailable {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.02);
            border: 1px dashed var(--border-light);
            border-radius: 4px;
            color: var(--muted-foreground);
            font-size: 11px;
            font-family: 'Geist Mono', monospace;
        }

        .lastfm-unavailable-icon {
            font-size: 16px;
            opacity: 0.5;
        }

        .lastfm-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 1.5rem;
            color: var(--muted-foreground);
            font-size: 11px;
            font-family: 'Geist Mono', monospace;
        }

        .lastfm-loading .loading-spinner {
            width: 16px;
            height: 16px;
        }

        .lastfm-content {
            display: grid;
            gap: 1rem;
        }

        .lastfm-now-playing {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 1rem;
            background: rgba(213, 16, 7, 0.05);
            border: 1px solid rgba(213, 16, 7, 0.2);
            border-radius: 4px;
        }

        .lastfm-album-art {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            background: var(--border-light);
            flex-shrink: 0;
        }

        .lastfm-track-info {
            flex: 1;
            min-width: 0;
        }

        .lastfm-track-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--foreground);
            font-family: 'Geist Mono', monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lastfm-artist-name {
            font-size: 11px;
            color: var(--muted-foreground);
            font-family: 'Geist Mono', monospace;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .lastfm-playing-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 9px;
            color: #d51007;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: 'Geist Mono', monospace;
            flex-shrink: 0;
        }

        .lastfm-playing-dot {
            width: 6px;
            height: 6px;
            background: #d51007;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .lastfm-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .lastfm-stat-card {
            padding: 0.75rem 1rem;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-light);
            border-radius: 4px;
        }

        .lastfm-stat-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--foreground);
            font-family: 'Geist Mono', monospace;
        }

        .lastfm-stat-label {
            font-size: 9px;
            color: var(--muted-foreground);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: 'Geist Mono', monospace;
            margin-top: 2px;
        }

        .lastfm-top-artists {
            margin-top: 0.5rem;
        }

        .lastfm-top-title {
            font-size: 9px;
            color: var(--muted-foreground);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: 'Geist Mono', monospace;
            margin-bottom: 0.5rem;
        }

        .lastfm-artists-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .lastfm-artist-tag {
            font-size: 10px;
            color: var(--foreground);
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-light);
            padding: 4px 8px;
            border-radius: 3px;
            font-family: 'Geist Mono', monospace;
        }

        .lastfm-artist-tag .plays {
            color: var(--muted-foreground);
            font-size: 9px;
            margin-left: 4px;
        }

        .lastfm-error {
            padding: 1rem;
            background: rgba(255, 100, 100, 0.05);
            border: 1px solid rgba(255, 100, 100, 0.2);
            border-radius: 4px;
            color: var(--muted-foreground);
            font-size: 11px;
            font-family: 'Geist Mono', monospace;
            text-align: center;
        }

        /* ============================================
           RESPONSIVE
           ============================================ */
        @media (max-width: 768px) {
            .page-layout {
                flex-direction: column;
                padding-top: 70px;
            }

            .members-sidebar {
                width: 100%;
            }

            .members-card {
                position: static;
            }

            .members-list {
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- User Profile Button (Top Center) -->
    <div class="user-profile-container">
        <div class="user-profile" id="userProfile" style="display: none;">
            <img src="" alt="Avatar" class="user-avatar" id="userAvatar">
            <span class="user-name" id="userName">...</span>
            <div class="user-dropdown-icon"></div>
            <div class="user-dropdown" id="userDropdown">
                <a href="/perfil" class="user-dropdown-item">Perfil</a>
                <div class="user-dropdown-item" id="logoutBtn">Logout</div>
            </div>
        </div>
        <a href="/" class="login-link" id="loginLink">[ LOGIN ]</a>
    </div>

    <div class="page-layout">
        <!-- Members Sidebar -->
        <aside class="members-sidebar">
            <div class="members-card">
                <div class="members-header">
                    <div class="members-title">Membros do Servidor</div>
                </div>
                <div class="members-list" id="membersList">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <span>Carregando...</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Profile Content -->
        <main class="profile-main">
            <!-- Loading State -->
            <div class="profile-card" id="loadingState">
                <div class="loading-state">
                    <div class="loading-spinner"></div>
                    <span>Carregando perfil...</span>
                </div>
            </div>

            <!-- Not Logged In State -->
            <div class="profile-card" id="notLoggedState" style="display: none;">
                <div class="not-logged-in">
                    <p>Voc√™ precisa estar logado para ver seu perfil.</p>
                    <a href="/" class="back-link">Fazer Login</a>
                </div>
            </div>

            <!-- Profile Content -->
            <div class="profile-card" id="profileContent" style="display: none;">
                <div class="profile-header">
                    <img src="" alt="Avatar" class="profile-avatar" id="profileAvatar">
                    <div class="profile-info">
                        <div class="profile-name" id="profileName">...</div>
                        <div class="profile-id" id="profileId">ID: ...</div>
                        <div class="profile-badge" id="profileBadge">Membro</div>
                    </div>
                </div>

                <div class="profile-section">
                    <div class="profile-section-title">Informa√ß√µes</div>
                    <div class="profile-field">
                        <span class="profile-field-label">Nome de usu√°rio</span>
                        <span class="profile-field-value" id="fieldUserName">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Discord ID</span>
                        <span class="profile-field-value" id="fieldUserId">-</span>
                    </div>
                    <div class="profile-field">
                        <span class="profile-field-label">Status Discord</span>
                        <span class="profile-field-value" id="fieldStatus">-</span>
                    </div>
                </div>

                <!-- Last.fm Section -->
                <div class="lastfm-section" id="lastfmSection">
                    <div class="lastfm-header">
                        <div class="lastfm-title">
                            <svg class="lastfm-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path d="M10.584 17.21l-.88-2.392s-1.43 1.594-3.573 1.594c-1.897 0-3.244-1.649-3.244-4.288 0-3.381 1.704-4.591 3.381-4.591 2.42 0 3.189 1.567 3.849 3.574l.88 2.749c.88 2.666 2.529 4.81 7.285 4.81 3.409 0 5.718-1.044 5.718-3.793 0-2.227-1.265-3.381-3.63-3.931l-1.758-.385c-1.21-.275-1.567-.77-1.567-1.595 0-.934.742-1.484 1.952-1.484 1.32 0 2.034.495 2.144 1.677l2.749-.33c-.22-2.474-1.924-3.492-4.729-3.492-2.474 0-4.893.935-4.893 3.932 0 1.87.907 3.051 3.189 3.601l1.87.44c1.402.33 1.869.907 1.869 1.704 0 1.017-.99 1.43-2.86 1.43-2.776 0-3.931-1.457-4.591-3.464l-.907-2.749c-1.155-3.573-2.997-4.893-6.653-4.893C2.144 5.333 0 7.89 0 12.233c0 4.18 2.144 6.434 5.993 6.434 3.106 0 4.591-1.457 4.591-1.457z"/>
                            </svg>
                            <span>O que anda ouvindo</span>
                        </div>
                        <div class="lastfm-username" id="lastfmUsername"></div>
                    </div>
                    <div id="lastfmContent">
                        <div class="lastfm-loading">
                            <div class="loading-spinner"></div>
                            <span>Carregando Last.fm...</span>
                        </div>
                    </div>
                </div>
            </div>

            <a href="/" class="back-link">‚Üê Voltar</a>
        </main>
    </div>

    <script>
        // === Elements ===
        const userProfile = document.getElementById('userProfile');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userDropdown = document.getElementById('userDropdown');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginLink = document.getElementById('loginLink');

        const membersList = document.getElementById('membersList');
        const loadingState = document.getElementById('loadingState');
        const notLoggedState = document.getElementById('notLoggedState');
        const profileContent = document.getElementById('profileContent');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileId = document.getElementById('profileId');
        const profileBadge = document.getElementById('profileBadge');
        const fieldUserName = document.getElementById('fieldUserName');
        const fieldUserId = document.getElementById('fieldUserId');
        const fieldStatus = document.getElementById('fieldStatus');

        // Current user data
        let currentUserId = null;
        let allMembers = [];

        // Default avatar placeholder
        const defaultAvatar = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23666"%3E%3Cpath d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/%3E%3C/svg%3E';

        // Load current user info
        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/user-info');
                const data = await response.json();
                
                if (data.authenticated && data.userName) {
                    currentUserId = data.userId;
                    
                    // Show header profile button
                    userAvatar.src = data.avatar || defaultAvatar;
                    userName.textContent = data.userName;
                    userProfile.style.display = 'flex';
                    loginLink.style.display = 'none';
                    
                    return true;
                } else {
                    userProfile.style.display = 'none';
                    loginLink.style.display = 'block';
                    loadingState.style.display = 'none';
                    notLoggedState.style.display = 'block';
                    return false;
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rio:', error);
                loadingState.style.display = 'none';
                notLoggedState.style.display = 'block';
                return false;
            }
        }

        // Load all members from Discord
        async function loadMembers() {
            try {
                const response = await fetch('/api/discord/members');
                const data = await response.json();
                
                if (data.members && data.members.length > 0) {
                    allMembers = data.members;
                    renderMembersList();
                    
                    // Select current user by default, or first member
                    const currentMember = allMembers.find(m => m.id === currentUserId);
                    if (currentMember) {
                        selectMember(currentMember);
                    } else if (allMembers.length > 0) {
                        selectMember(allMembers[0]);
                    }
                } else {
                    membersList.innerHTML = '<div class="loading-state"><span>Nenhum membro encontrado</span></div>';
                }
            } catch (error) {
                console.error('Erro ao carregar membros:', error);
                membersList.innerHTML = '<div class="loading-state"><span>Erro ao carregar</span></div>';
            }
        }

        // Render the members list
        function renderMembersList() {
            membersList.innerHTML = '';
            
            allMembers.forEach(member => {
                const isCurrentUser = member.id === currentUserId;
                const isOnline = member.status === 'online' || member.status === 'idle' || member.status === 'dnd';
                
                const memberItem = document.createElement('div');
                memberItem.className = 'member-item' + (isCurrentUser ? ' is-you' : '');
                memberItem.dataset.memberId = member.id;
                
                memberItem.innerHTML = `
                    <img src="${member.avatar || defaultAvatar}" alt="${member.name}" class="member-avatar">
                    <div class="member-info">
                        <div class="member-name">${member.displayName || member.name}</div>
                        <div class="member-status">
                            <span class="member-status-dot ${isOnline ? 'online' : ''}"></span>
                            ${member.status || 'offline'}
                        </div>
                    </div>
                    ${isCurrentUser ? '<span class="member-you-badge">VOC√ä</span>' : ''}
                `;
                
                memberItem.addEventListener('click', () => selectMember(member));
                membersList.appendChild(memberItem);
            });
        }

        // Select a member to view their profile
        function selectMember(member) {
            // Update active state in list
            document.querySelectorAll('.member-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.memberId === member.id) {
                    item.classList.add('active');
                }
            });
            
            // Hide loading, show profile
            loadingState.style.display = 'none';
            profileContent.style.display = 'block';
            
            // Update profile content
            const isCurrentUser = member.id === currentUserId;
            const isOnline = member.status === 'online' || member.status === 'idle' || member.status === 'dnd';
            
            profileAvatar.src = member.avatar || defaultAvatar;
            profileName.textContent = member.displayName || member.name;
            profileId.textContent = `ID: ${member.id}`;
            
            // Update badge
            if (isCurrentUser) {
                profileBadge.textContent = 'Voc√™';
                profileBadge.classList.add('you');
            } else {
                profileBadge.textContent = 'Membro';
                profileBadge.classList.remove('you');
            }
            
            // Update fields
            fieldUserName.textContent = member.displayName || member.name;
            fieldUserId.textContent = member.id;
            fieldStatus.innerHTML = `<span style="color: ${isOnline ? 'var(--accent)' : 'var(--muted-foreground)'}">${member.status || 'offline'}</span>`;
            
            // Render Last.fm section
            renderLastFmSection(member.id);
        }

        // Toggle dropdown
        userProfile.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('active');
        });

        // Logout
        logoutBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/';
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
            }
        });

        // Close dropdown on outside click
        document.addEventListener('click', () => {
            userDropdown.classList.remove('active');
        });

        // === Last.fm Configuration ===
        const LASTFM_API_KEY = '71cbcac613a06f0ea7e289635b234578';
        
        // Mapeamento Discord ID -> Last.fm Username
        const LASTFM_USERS = {
            '268826484850819072': 'dnkocsh',           // danos
            '351819031147184139': 'Alycos',            // historia natural
            '373150815076220948': 'AllaNaroK',         // Koran
            '715414320078389338': null,                 // lucaspb (n√£o possui)
            // mhassahrolin n√£o possui
        };

        // Fetch Last.fm data for a user
        async function fetchLastFmData(username) {
            const baseUrl = 'https://ws.audioscrobbler.com/2.0/';
            
            try {
                // Fetch recent tracks (includes now playing)
                const recentTracksUrl = `${baseUrl}?method=user.getrecenttracks&user=${username}&api_key=${LASTFM_API_KEY}&format=json&limit=1`;
                const recentRes = await fetch(recentTracksUrl);
                const recentData = await recentRes.json();
                
                // Fetch user info (for total scrobbles)
                const userInfoUrl = `${baseUrl}?method=user.getinfo&user=${username}&api_key=${LASTFM_API_KEY}&format=json`;
                const userRes = await fetch(userInfoUrl);
                const userData = await userRes.json();
                
                // Fetch top artists
                const topArtistsUrl = `${baseUrl}?method=user.gettopartists&user=${username}&api_key=${LASTFM_API_KEY}&format=json&limit=5&period=1month`;
                const artistsRes = await fetch(topArtistsUrl);
                const artistsData = await artistsRes.json();
                
                return {
                    recentTracks: recentData.recenttracks,
                    userInfo: userData.user,
                    topArtists: artistsData.topartists
                };
            } catch (error) {
                console.error('Erro ao buscar dados do Last.fm:', error);
                return null;
            }
        }

        // Render Last.fm section
        function renderLastFmSection(discordId) {
            const lastfmContent = document.getElementById('lastfmContent');
            const lastfmUsername = document.getElementById('lastfmUsername');
            const lastfmSection = document.getElementById('lastfmSection');
            
            const username = LASTFM_USERS[discordId];
            
            // Se o usu√°rio n√£o tem Last.fm configurado
            if (username === null || username === undefined) {
                lastfmUsername.innerHTML = '';
                lastfmContent.innerHTML = `
                    <div class="lastfm-unavailable">
                        <span class="lastfm-unavailable-icon">üéµ</span>
                        <span>Este membro ainda n√£o conectou sua conta Last.fm</span>
                    </div>
                `;
                return;
            }
            
            // Mostra loading
            lastfmUsername.innerHTML = `<a href="https://www.last.fm/user/${username}" target="_blank">@${username}</a>`;
            lastfmContent.innerHTML = `
                <div class="lastfm-loading">
                    <div class="loading-spinner"></div>
                    <span>Carregando Last.fm...</span>
                </div>
            `;
            
            // Busca os dados
            fetchLastFmData(username).then(data => {
                if (!data || !data.userInfo) {
                    lastfmContent.innerHTML = `
                        <div class="lastfm-error">
                            N√£o foi poss√≠vel carregar os dados do Last.fm
                        </div>
                    `;
                    return;
                }
                
                let html = '<div class="lastfm-content">';
                
                // Verifica se est√° tocando agora
                const tracks = data.recentTracks?.track;
                if (tracks && tracks.length > 0) {
                    const currentTrack = tracks[0];
                    const isNowPlaying = currentTrack['@attr']?.nowplaying === 'true';
                    const albumArt = currentTrack.image?.find(img => img.size === 'medium')?.['#text'] || '';
                    
                    if (isNowPlaying) {
                        html += `
                            <div class="lastfm-now-playing">
                                <img src="${albumArt || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23666"%3E%3Crect width="24" height="24" rx="2"/%3E%3C/svg%3E'}" alt="Album" class="lastfm-album-art">
                                <div class="lastfm-track-info">
                                    <div class="lastfm-track-name">${escapeHtml(currentTrack.name)}</div>
                                    <div class="lastfm-artist-name">${escapeHtml(currentTrack.artist['#text'] || currentTrack.artist)}</div>
                                </div>
                                <div class="lastfm-playing-badge">
                                    <span class="lastfm-playing-dot"></span>
                                    <span>TOCANDO</span>
                                </div>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="lastfm-now-playing" style="background: rgba(255,255,255,0.02); border-color: var(--border-light);">
                                <img src="${albumArt || 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23666"%3E%3Crect width="24" height="24" rx="2"/%3E%3C/svg%3E'}" alt="Album" class="lastfm-album-art">
                                <div class="lastfm-track-info">
                                    <div class="lastfm-track-name">${escapeHtml(currentTrack.name)}</div>
                                    <div class="lastfm-artist-name">${escapeHtml(currentTrack.artist['#text'] || currentTrack.artist)}</div>
                                </div>
                                <div class="lastfm-playing-badge" style="color: var(--muted-foreground);">
                                    <span>√öLTIMA</span>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Stats
                const playcount = parseInt(data.userInfo.playcount || 0).toLocaleString('pt-BR');
                const artistCount = parseInt(data.userInfo.artist_count || 0).toLocaleString('pt-BR');
                
                html += `
                    <div class="lastfm-stats">
                        <div class="lastfm-stat-card">
                            <div class="lastfm-stat-value">${playcount}</div>
                            <div class="lastfm-stat-label">Scrobbles</div>
                        </div>
                        <div class="lastfm-stat-card">
                            <div class="lastfm-stat-value">${artistCount}</div>
                            <div class="lastfm-stat-label">Artistas</div>
                        </div>
                    </div>
                `;
                
                // Top Artists
                const topArtists = data.topArtists?.artist;
                if (topArtists && topArtists.length > 0) {
                    html += `
                        <div class="lastfm-top-artists">
                            <div class="lastfm-top-title">Top Artistas (√∫ltimo m√™s)</div>
                            <div class="lastfm-artists-list">
                    `;
                    topArtists.forEach(artist => {
                        html += `<span class="lastfm-artist-tag">${escapeHtml(artist.name)}<span class="plays">${artist.playcount}x</span></span>`;
                    });
                    html += '</div></div>';
                }
                
                html += '</div>';
                lastfmContent.innerHTML = html;
            });
        }
        
        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        async function init() {
            const isLoggedIn = await loadCurrentUser();
            if (isLoggedIn) {
                await loadMembers();
            }
        }

        init();
    </script>
</body>
</html>
