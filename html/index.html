<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MHASSAHROPOLIS</title>
    <link rel="preconnect" href="https://fonts.bunny.net">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.bunny.net/css?family=geist-mono:400,500,600,700" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- User Profile Button (Top Center) -->
    <div class="user-profile-container">
        <div class="user-profile" id="userProfile" style="display: none;">
            <img src="" alt="Avatar" class="user-avatar" id="userAvatar">
            <span class="user-name" id="userName">...</span>
            <div class="user-dropdown-icon"></div>
            <div class="user-dropdown" id="userDropdown">
                <div class="user-dropdown-item" id="logoutBtn">Logout</div>
            </div>
        </div>
        <a href="mine.html" class="login-link" id="loginLink">[ LOGIN ]</a>
    </div>

    <main class="main-content">
        <h1>MHASSAHRO
POLIS</h1>

        <div class="pcs-container" id="pcs-container">
            <!-- PCs will be inserted here by JS -->
        </div>

        <div class="image-container">
            <img src="../usar.jpg" alt="Low poly girl">
        </div>

        <nav>
            <a href="mine.html">mine</a>
            <a href="/about">about</a>
        </nav>
    </main>

    <div class="footer">•••</div>

    <script>
        const pcs = [
            { name: "alysson", ip: "192.168.1.10", online: true },
            { name: "allan", ip: "192.168.1.11", online: true },
            { name: "daniel", ip: "192.168.1.12", online: false },
            { name: "lucas", ip: "192.168.1.13", online: true },
        ];

        const container = document.getElementById('pcs-container');

        pcs.forEach(pc => {
            const pcDiv = document.createElement('div');
            pcDiv.className = 'pc';

            const statusDiv = document.createElement('div');
            statusDiv.className = 'pc-status';

            const dot = document.createElement('span');
            dot.className = `status-dot ${pc.online ? 'online' : 'offline'}`;

            const nameSpan = document.createElement('span');
            nameSpan.className = 'pc-name';
            nameSpan.textContent = pc.name;

            statusDiv.appendChild(dot);
            statusDiv.appendChild(nameSpan);

            const ipSpan = document.createElement('span');
            ipSpan.className = 'pc-ip';
            ipSpan.textContent = pc.ip;

            pcDiv.appendChild(statusDiv);
            pcDiv.appendChild(ipSpan);

            container.appendChild(pcDiv);
        });

        // === User Profile (reusing server.py auth) ===
        const userProfile = document.getElementById('userProfile');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const userDropdown = document.getElementById('userDropdown');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginLink = document.getElementById('loginLink');

        async function loadUserProfile() {
            try {
                const response = await fetch('/api/user-info');
                const data = await response.json();
                
                if (data.authenticated && data.userName) {
                    userAvatar.src = data.avatar || '';
                    userName.textContent = data.userName;
                    userProfile.style.display = 'flex';
                    loginLink.style.display = 'none';
                } else {
                    userProfile.style.display = 'none';
                    loginLink.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
                userProfile.style.display = 'none';
                loginLink.style.display = 'block';
            }
        }

        // Toggle dropdown
        userProfile.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('active');
        });

        // Logout
        logoutBtn.addEventListener('click', async (e) => {
            e.stopPropagation();
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.reload();
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
            }
        });

        // Close dropdown on outside click
        document.addEventListener('click', () => {
            userDropdown.classList.remove('active');
        });

        // Load profile on page load
        loadUserProfile();
    </script>
</body>
</html>
